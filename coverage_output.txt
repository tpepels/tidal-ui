
> tidal-ui@3.0.0 test:coverage
> vitest run --coverage


 RUN  v1.6.1 /home/tom/Projects/tidal-ui
      Coverage enabled with v8

 ✓ src/lib/utils/performance.test.ts  (14 tests) 3ms
 ✓ src/lib/utils/formatters.test.ts  (17 tests) 14ms
 ✓ src/lib/utils/audioQuality.test.ts  (12 tests) 4ms
 ❯ src/lib/utils/colorPalette.test.ts  (0 test)
 ❯ src/lib/utils/persistence.test.ts  (0 test)
stderr | src/lib/utils/schemas.test.ts > Schemas > validateApiResponse > throws on invalid data
API response validation failed: ZodError: [
  {
    "expected": "number",
    "code": "invalid_type",
    "path": [
      "id"
    ],
    "message": "Invalid input: expected number, received undefined"
  },
  {
    "expected": "array",
    "code": "invalid_type",
    "path": [
      "artists"
    ],
    "message": "Invalid input: expected array, received undefined"
  }
]
    at Module.validateApiResponse (/home/tom/Projects/tidal-ui/src/lib/utils/schemas.ts:93:17)
    at /home/tom/Projects/tidal-ui/src/lib/utils/schemas.test.ts:136:17
    at Proxy.assertThrows (/home/tom/Projects/tidal-ui/node_modules/chai/lib/chai/core/assertions.js:2644:7)
    at Proxy.methodWrapper (/home/tom/Projects/tidal-ui/node_modules/chai/lib/chai/utils/addMethod.js:57:25)
    at Proxy.<anonymous> (file:///home/tom/Projects/tidal-ui/node_modules/@vitest/expect/dist/index.js:850:16)
    at Proxy.overwritingMethodWrapper (/home/tom/Projects/tidal-ui/node_modules/chai/lib/chai/utils/overwriteMethod.js:78:33)
    at Proxy.<anonymous> (file:///home/tom/Projects/tidal-ui/node_modules/@vitest/expect/dist/index.js:1324:19)
    at Proxy.<anonymous> (file:///home/tom/Projects/tidal-ui/node_modules/@vitest/expect/dist/index.js:800:17)
    at Proxy.methodWrapper (/home/tom/Projects/tidal-ui/node_modules/chai/lib/chai/utils/addMethod.js:57:25)
    at /home/tom/Projects/tidal-ui/src/lib/utils/schemas.test.ts:136:57

stderr | src/lib/utils/schemas.test.ts > Schemas > assertInvariant > throws in dev mode on false condition
Invariant violation: test

 ❯ src/lib/downloads.test.ts  (0 test)
stderr | src/lib/services/playback.service.test.ts > PlaybackService > handles API errors gracefully
Error in API request to /track/?id=123&quality=LOSSLESS: TidalError: Track not found.
    at TidalError.fromApiResponse (/home/tom/Projects/tidal-ui/src/lib/errors.ts:28:11)
    at /home/tom/Projects/tidal-ui/src/lib/services/base-api.service.ts:33:23
    at Module.retryWithBackoff (/home/tom/Projects/tidal-ui/src/lib/errors.ts:174:11)
    at operation (/home/tom/Projects/tidal-ui/src/lib/services/base-api.service.ts:30:19)
    at /home/tom/Projects/tidal-ui/src/lib/errors.ts:78:11
    at /home/tom/Projects/tidal-ui/src/lib/services/playback.service.test.ts:157:3
    at runTest (file:///home/tom/Projects/tidal-ui/node_modules/@vitest/runner/dist/index.js:781:11)
    at runSuite (file:///home/tom/Projects/tidal-ui/node_modules/@vitest/runner/dist/index.js:909:15)
    at runSuite (file:///home/tom/Projects/tidal-ui/node_modules/@vitest/runner/dist/index.js:909:15)
    at runFiles (file:///home/tom/Projects/tidal-ui/node_modules/@vitest/runner/dist/index.js:958:5) {
  code: 'NOT_FOUND',
  statusCode: 404,
  isRetryable: false
}

 ✓ src/lib/utils/colorExtraction.test.ts  (17 tests) 6ms
 ✓ src/lib/errors.test.ts  (12 tests) 6ms
stderr | src/lib/services/content.service.test.ts > ContentService > handles API errors for album
Error in API request to /album/?id=999: TidalError: Track not found.
    at TidalError.fromApiResponse (/home/tom/Projects/tidal-ui/src/lib/errors.ts:28:11)
    at /home/tom/Projects/tidal-ui/src/lib/services/base-api.service.ts:33:23
    at Module.retryWithBackoff (/home/tom/Projects/tidal-ui/src/lib/errors.ts:174:11)
    at operation (/home/tom/Projects/tidal-ui/src/lib/services/base-api.service.ts:30:19)
    at /home/tom/Projects/tidal-ui/src/lib/errors.ts:78:11
    at /home/tom/Projects/tidal-ui/src/lib/services/content.service.test.ts:191:3
    at runTest (file:///home/tom/Projects/tidal-ui/node_modules/@vitest/runner/dist/index.js:781:11)
    at runSuite (file:///home/tom/Projects/tidal-ui/node_modules/@vitest/runner/dist/index.js:909:15)
    at runSuite (file:///home/tom/Projects/tidal-ui/node_modules/@vitest/runner/dist/index.js:909:15)
    at runFiles (file:///home/tom/Projects/tidal-ui/node_modules/@vitest/runner/dist/index.js:958:5) {
  code: 'NOT_FOUND',
  statusCode: 404,
  isRetryable: false
}

stderr | src/lib/services/content.service.test.ts > ContentService > handles API errors for artist
Error in API request to /artist/?id=999: TidalError: Track not found.
    at TidalError.fromApiResponse (/home/tom/Projects/tidal-ui/src/lib/errors.ts:28:11)
    at /home/tom/Projects/tidal-ui/src/lib/services/base-api.service.ts:33:23
    at Module.retryWithBackoff (/home/tom/Projects/tidal-ui/src/lib/errors.ts:174:11)
    at operation (/home/tom/Projects/tidal-ui/src/lib/services/base-api.service.ts:30:19)
    at /home/tom/Projects/tidal-ui/src/lib/errors.ts:78:11
    at /home/tom/Projects/tidal-ui/src/lib/services/content.service.test.ts:197:3
    at runTest (file:///home/tom/Projects/tidal-ui/node_modules/@vitest/runner/dist/index.js:781:11)
    at runSuite (file:///home/tom/Projects/tidal-ui/node_modules/@vitest/runner/dist/index.js:909:15)
    at runSuite (file:///home/tom/Projects/tidal-ui/node_modules/@vitest/runner/dist/index.js:909:15)
    at runFiles (file:///home/tom/Projects/tidal-ui/node_modules/@vitest/runner/dist/index.js:958:5) {
  code: 'NOT_FOUND',
  statusCode: 404,
  isRetryable: false
}

 ✓ src/lib/utils/songlink.test.ts  (14 tests) 11ms
 ✓ src/lib/services/content.service.test.ts  (11 tests) 34ms
 ✓ src/lib/utils/validation.test.ts  (24 tests) 12ms
 ✓ src/lib/services/base-api.service.test.ts  (6 tests) 10ms
 ❯ src/lib/services/tidal-api.client.test.ts  (0 test)
 ✓ src/lib/utils/schemas.test.ts  (12 tests) 20ms
 ✓ src/lib/services/playback.service.test.ts  (15 tests) 29ms
 ❯ src/lib/api.integration.test.ts  (0 test)
 ✓ src/lib/utils/cache.test.ts  (9 tests) 10ms
stderr | src/lib/utils/urlParser.test.ts > URL Parser > parseTidalUrl > handles invalid URLs gracefully
Failed to parse Tidal URL: TypeError: Invalid URL: https://
    at new URLImpl (/home/tom/Projects/tidal-ui/node_modules/jsdom/node_modules/whatwg-url/lib/URL-impl.js:20:13)
    at Object.exports.setup (/home/tom/Projects/tidal-ui/node_modules/jsdom/node_modules/whatwg-url/lib/URL.js:54:12)
    at new URL (/home/tom/Projects/tidal-ui/node_modules/jsdom/node_modules/whatwg-url/lib/URL.js:115:22)
    at Module.parseTidalUrl (/home/tom/Projects/tidal-ui/src/lib/utils/urlParser.ts:39:13)
    at /home/tom/Projects/tidal-ui/src/lib/utils/urlParser.test.ts:102:11
    at file:///home/tom/Projects/tidal-ui/node_modules/@vitest/runner/dist/index.js:135:14
    at file:///home/tom/Projects/tidal-ui/node_modules/@vitest/runner/dist/index.js:60:26
    at runTest (file:///home/tom/Projects/tidal-ui/node_modules/@vitest/runner/dist/index.js:781:17)
    at runSuite (file:///home/tom/Projects/tidal-ui/node_modules/@vitest/runner/dist/index.js:909:15)
    at runSuite (file:///home/tom/Projects/tidal-ui/node_modules/@vitest/runner/dist/index.js:909:15)

 ✓ src/lib/utils/webglShaders.test.ts  (6 tests) 4ms
 ❯ src/lib/utils/api-availability.test.ts  (0 test)
 ✓ src/lib/utils/urlParser.test.ts  (14 tests) 15ms
 ✓ src/lib/services/search.service.test.ts  (4 tests) 11ms
 ✓ src/lib/components/LazyImage.test.ts  (1 test) 2ms
 ✓ src/lib/stores/player.test.ts  (1 test) 3ms

⎯⎯⎯⎯⎯⎯ Failed Suites 6 ⎯⎯⎯⎯⎯⎯⎯

 FAIL  src/lib/api.integration.test.ts [ src/lib/api.integration.test.ts ]
Error: Failed to resolve import "$lib/utils/audioQuality" from "src/lib/api.ts". Does the file exist?
 ❯ TransformPluginContext._formatError node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:49258:41
 ❯ TransformPluginContext.error node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:49253:16
 ❯ normalizeUrl node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:64307:23
 ❯ async file:/home/tom/Projects/tidal-ui/node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:64439:39
 ❯ TransformPluginContext.transform node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:64366:7
 ❯ PluginContainer.transform node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:49099:18
 ❯ loadAndTransform node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:51978:27

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[1/6]⎯

 FAIL  src/lib/downloads.test.ts [ src/lib/downloads.test.ts ]
Error: Failed to resolve import "$lib/api" from "src/lib/downloads.ts". Does the file exist?
 ❯ TransformPluginContext._formatError node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:49258:41
 ❯ TransformPluginContext.error node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:49253:16
 ❯ normalizeUrl node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:64307:23
 ❯ async file:/home/tom/Projects/tidal-ui/node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:64439:39
 ❯ TransformPluginContext.transform node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:64366:7
 ❯ PluginContainer.transform node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:49099:18
 ❯ loadAndTransform node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:51978:27

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[2/6]⎯

 FAIL  src/lib/services/tidal-api.client.test.ts [ src/lib/services/tidal-api.client.test.ts ]
Error: Failed to resolve import "$lib/version" from "src/lib/config.ts". Does the file exist?
 ❯ TransformPluginContext._formatError node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:49258:41
 ❯ TransformPluginContext.error node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:49253:16
 ❯ normalizeUrl node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:64307:23
 ❯ async file:/home/tom/Projects/tidal-ui/node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:64439:39
 ❯ TransformPluginContext.transform node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:64366:7
 ❯ PluginContainer.transform node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:49099:18
 ❯ loadAndTransform node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:51978:27

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[3/6]⎯

 FAIL  src/lib/utils/api-availability.test.ts [ src/lib/utils/api-availability.test.ts ]
Error: Failed to resolve import "$lib/version" from "src/lib/config.ts". Does the file exist?
 ❯ TransformPluginContext._formatError node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:49258:41
 ❯ TransformPluginContext.error node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:49253:16
 ❯ normalizeUrl node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:64307:23
 ❯ async file:/home/tom/Projects/tidal-ui/node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:64439:39
 ❯ TransformPluginContext.transform node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:64366:7
 ❯ PluginContainer.transform node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:49099:18
 ❯ loadAndTransform node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:51978:27

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[4/6]⎯

 FAIL  src/lib/utils/colorPalette.test.ts [ src/lib/utils/colorPalette.test.ts ]
Error: Failed to resolve import "$app/environment" from "src/lib/utils/colorPalette.ts". Does the file exist?
 ❯ TransformPluginContext._formatError node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:49258:41
 ❯ TransformPluginContext.error node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:49253:16
 ❯ normalizeUrl node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:64307:23
 ❯ async file:/home/tom/Projects/tidal-ui/node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:64439:39
 ❯ TransformPluginContext.transform node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:64366:7
 ❯ PluginContainer.transform node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:49099:18
 ❯ loadAndTransform node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:51978:27

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[5/6]⎯

 FAIL  src/lib/utils/persistence.test.ts [ src/lib/utils/persistence.test.ts ]
Error: Failed to resolve import "$app/environment" from "src/lib/utils/persistence.ts". Does the file exist?
 ❯ TransformPluginContext._formatError node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:49258:41
 ❯ TransformPluginContext.error node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:49253:16
 ❯ normalizeUrl node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:64307:23
 ❯ async file:/home/tom/Projects/tidal-ui/node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:64439:39
 ❯ TransformPluginContext.transform node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:64366:7
 ❯ PluginContainer.transform node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:49099:18
 ❯ loadAndTransform node_modules/vitest/node_modules/vite/dist/node/chunks/dep-BK3b2jBa.js:51978:27

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[6/6]⎯

 Test Files  6 failed | 17 passed (23)
      Tests  189 passed (189)
   Start at  16:34:31
   Duration  2.65s (transform 1.20s, setup 1.56s, collect 1.51s, tests 194ms, environment 11.90s, prepare 3.96s)

